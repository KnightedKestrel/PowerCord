name: 'Validate Dockerfile Build and Run'

on:
    pull_request:
        branches: [master]
        paths:
            - 'bot/**'

concurrency:
    group: docker-validate-${{ github.ref }}
    cancel-in-progress: true

jobs:
    validate-docker:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Lint Dockerfile
              uses: hadolint/hadolint-action@v2.0.0
              with:
                  dockerfile: ./bot/Dockerfile

            - name: Build Docker image
              run: docker build -t powercord-bot-test .

            - name: Run Docker container
              run: |
                  docker run -d --name bot-test -p 3000:3000 powercord-bot-test
                  sleep 5
                  curl -f http://localhost:3000/health || exit 1
                  docker stop bot-test

            - name: Clean up
              if: always()
              run: docker rm bot-test || true
